# 主合约文档 (Main.sol)

## 积分转移

* 审核案件是否为有效信息 +2积分
* 发布案件通过审核后 +5积分
* 投票 +1积分
* 民警接受任务 -2积分 （押金）
* 民警完成任务 +7积分（退还2押金 5奖金）

# SETs

## 1.注册警方用户

（必填）_name: string 用户名

（可选）_avatarLink: string 头像的IPFS链接

```solidity
function createPoliceUser(string memory _name, string memory _avatarLink) external {}
```

## 2.注册市民用户

（必填）_name: string 用户名

（可选）_avatarLink: string 头像的IPFS链接

```solidity
function createCivilUser(string memory _name, string memory _avatarLink) external {}
```

## 3.上传案件

（可选）_title:  string 标题

（可选）_tag: string 类型

（描述和图片链接数组二选一必填）

_description: string 描述

_caseImageLink: string[] 相关图片的IPFS链接数组

```solidity
function postCase(string memory _title, string memory _tag, string memory _description, string[] memory _imageLinks) external {}
```

## 4.审核案件是否为有效诈骗信息（可批量）

_caseIndex: uint[] 要审核的案件编号的数组，传几个编号审核几个

_isValid: bool[] 要审核的案件是否为有效信息的数组

```solidity
function setCaseValidity(uint[] memory _caseIndex, bool[] memory _isValid) external {}
```

## 5.判断案件是否为诈骗案件（是否有诈骗嫌疑）

传入要判断的案件编号和是否为诈骗案件

```solidity
function setIsFraudCase(uint _caseIndex, bool _isFraud) external {}
```

## 6.向指定案件投票（是否有诈骗嫌疑）

传入案件编号和是否赞成

```solidity
function vote(uint _caseIndex, bool _isFraud) external {}
```

## 注：任务系统只对警方用户开放

## 7.手动发布任务

参数说明同3

```solidity
function postTask(string memory _title, string memory _tag, string memory _description, string[] memory _imageLinks) external {}
```

## 8.由案件转化为任务

传入案件编号

```solidity
function postTaskFromCase(uint _caseIndex) external {}
```

## 9.接受任务

传入任务编号

```solidity
function setCaseAccept(uint _taskIndex) external {}
```

## 10.发送任务回答

传入任务编号 是否是诈骗信息 回答详情

```solidity
function postReply2Task(uint _taskIndex, bool _isFraud, string memory _details) external {}
```

## 11.设置任务成功

传入任务编号

```solidity
function setCaseFinished(uint _taskIndex) external {}
```

## 12.设置任务失败（超过时限）

传入任务编号

```solidity
function setCaseFailed(uint _taskIndex) external {}
```

## 13.上传商品（仅供测试人员使用）

传入商品名 商品信息 积分价格 库存

```solidity
function createProduct(string memory _name, string memory _details, uint _price, uint _inventory) external {}
```

## 14.兑换商品

传入商品编号

```solidity
function purchase(uint _productIndex) external {}
```

## 15.发布交易贴

（可选）标题

（必填）描述

（必填）类型 出售/求购

图片链接数组（出售必填 求购可选）

（必填）意向价格

```solidity
function postTransactionPost(string memory _title, string memory _description, string memory _tag, string[] memory _imageLink, uint _price) external {}
```

## 16.发送回复（指定交易贴）

传入交易贴编号 回复层级（一级回复/二级回复/...）回复详情

```solidity
function postReply2TransactionPost(uint _transactionPostIndex, uint _level, string memory _details) external {}
```

# GETs

## 1.获取余额

传入要查询的地址

```solidity
function getBalanceOf(address _userAdd) external view returns (uint) {}
```

## 2.获取警方用户

传入要获取的用户地址

返回用户结构

```solidity
    // 用户结构
    struct User {
        // 用户id
        uint id;
        // 用户姓名
        string name;
        // 头像
        string avatarLink;
        // 地址
        address userAdd;
    }
```

```solidity
function getPoliceUser(address _userAdd) external view returns (User memory) {}
```

## 3.获取市民用户

传入要获取的用户地址

返回用户结构

```solidity
    // 用户结构
    struct User {
        // 用户id
        uint id;
        // 用户姓名
        string name;
        // 头像
        string avatarLink;
        // 地址
        address userAdd;
    }
```

```solidity
function getCivilUser(address _userAdd) external view returns (User memory) {}
```

## 4. 获取案件列表

返回案件结构数组

```solidity 
    // 案件结构
    struct Case {
        uint id;
        string title;
        // 案件类型
        string tag;
        string description;
        uint postTime;
        string[] imageLinks;
        // 发布人地址
        address userAdd;
        // 是否已经过审核
        bool isSetValidity;
        // 是否为有效信息
        bool isValid;
        // 是否为诈骗案
        bool isFraud;
    }
```

```solidity
function getCaseList() external view returns (Case[] memory) {}
```

## 5.获取我的历史审核案件（信息有效性）

返回案件结构数组

```solidity
function getMyHistoryCaseValiditySet() external view returns (Case[] memory) {}
```

## 6.获取指定案件状态

传入案件编号

返回状态编号

```
1.成功提交，等待审核中
2.已通过审核，已显示在案件广场中
3.未通过审核
```

```solidity
function getCaseState(uint _caseIndex) external view returns (uint) {}
```

## 7.获取当前地址是否已投票（指定案件）

传入案件编号

返回是否已投票

```solidity
function getIsVoted(uint _caseIndex) external view returns (bool) {}
```

## 8.获取指定案件得票数

传入案件编号

返回（赞成票数 否定票数 总得票数）

```solidity
function getVoteCountOf(uint _caseIndex) external view returns (uint, uint, uint) {}
```

## 9.获取任务列表

返回任务结构数组

```solidity
    // 无法确认的案件 => 任务
    struct Task {
        uint id;
        string title;
        string tag;
        string description;
        uint postTime;
        // 接受时间
        uint acceptTime;
        string[] imageLinks;
        // 发布人地址
        address userAdd;
        // 接受人地址
        address acceptAdd;
        // 是否已被接受
        bool isAccept;
        // 是否为诈骗案
        bool isFraud;
        // 是否已完成
        bool isFinished;
    }
```

```solidity
function getTaskList() external view returns (Task[] memory) {}
```

## 10.获取任务回答

返回是否是诈骗案件和回复结构

```solidity
    // 通用回复结构
    struct Reply {
        // 要回复的内容的id
        uint repoId;
        // 楼层
        uint floor;
        // 层级
        // 一级回复 = 1 二级回复 = 2...
        uint level;
        uint postTime;
        // 回复内容
        string details;
        // 回复用户地址
        address userAdd;
    }
```

```solidity
function getTaskReply(uint _taskIndex) external view returns (bool, Reply memory) {}
```

## 11.获取商品列表

返回商品结构数组

```solidity
    // 商品结构
    struct Product {
        uint id;
        string name;
        string details;
        uint price;
        // 库存
        uint inventory;
    }
```

```solidity
function getProductList() external view returns (Product[] memory) {}
```

## 12.获取交易贴列表

返回交易贴结构数组

```solidity
    // 交易贴
    struct TransactionPost {
        uint id;
        uint postTime;
        string title;
        string description;
        // 标签 出售 or 求购
        string tag;
        string[] imageLink;
        // 意向价格
        uint price;
        address userAdd;
        // 现有回复数量
        uint replyCounts;
    }
```

```solidity
function getTransactionPostList() external view returns (TransactionPost[] memory) {}
```

## 13.获取指定交易贴下的回复列表

传入要回复的交易贴编号

返回回复结构数组

```solidity
    // 通用回复结构
    struct Reply {
        // 要回复的内容的id
        uint repoId;
        // 楼层
        uint floor;
        // 层级
        // 一级回复 = 1 二级回复 = 2...
        uint level;
        uint postTime;
        // 回复内容
        string details;
        // 回复用户地址
        address userAdd;
    }
```

```solidity
function getTransactionPostReplyList(uint _transactionPostIndex) external view returns (Reply[] memory) {}
```



